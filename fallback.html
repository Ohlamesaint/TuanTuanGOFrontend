<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./app.js"></script>
</head>
<body>
    <button class="enable-notification">允許推播</button>
    <script>
        let enableNotifications = document.querySelectorAll('.enable-notification');
        
        if('Notification' in window) {
            for(let i=0; i<enableNotifications.length; i++){
                enableNotifications[i].style.display = 'inline-block';
                enableNotifications[i].addEventListener('click', askForNotificationPermission);
            }
        }
        
        function askForNotificationPermission() {
            Notification.requestPermission((status) => {
                console.log('User choice', status);
                if(status!=='granted'){
                    console.log('user denied');
                } else {
                    setPushSubcribe();
                }
            })
        }
        
        function displayNotification() {
            if('serviceWorker' in navigator){
                var options = {
                    body: '團購中的訊息',
                    icon: './public/img/tuantuango196.png',
                    image: './public/img/tuantuango196.png',
                    dir: 'ltr',
                    lang: 'zh-Hant',
                    vibrate: [100],
                    badge: './public/img/tuantuango196.png',
                    tag: 'confirm-notification',
                    renotify: true,
                    actions: [{
                        action: 'confirm', title: '確認', icon: './public/img/tuantuango196.png'
                    },{
                        action: 'cancel', title: '取消', icon: './public/img/tuantuango196.png'
                    }]
                };
                navigator.serviceWorker.ready
                .then((sw) => {
                    sw.showNotification('訂閱成功', options);
                })
            }
        }
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        
        function setPushSubcribe() {
            let serviceWorkerRegistration;
            navigator.serviceWorker.ready
            .then((sw) => {
                serviceWorkerRegistration = sw;
                return sw.pushManager.getSubscription();
            }).then((sub) => {
                console.log(sub);
                if(sub === null){
                    let vapidKey = 'BDS16gOHo-U1qqgD6cGbLMTEZe_lrbgk3aKAs3T38YQiFvoucK7hSRjJUJhuj8e4_PxqIWm-CWc3OFOi2sSXbZI';
                    let convertedVapidKey = urlBase64ToUint8Array(vapidKey);
                    serviceWorkerRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedVapidKey
                    }).then((newSub) => {
                        console.log(newSub);
                        return axios({
                            method:'post',
                            url: "https://tuantuango.herokuapp.com/subscribe",
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            data: newSub
                        }).then((res) => {
                            console.log('subscribe success', res);
                            if(response.ok){
                                displayNotification();
                            }
                        }).catch((err) => {
                            console.log('Something went wrong => fallback => newSub', err);
                        })
                    });
                } else {
                    console.log(sub);
                }
            })
        }
        
        self.addEventListener('notificationonclick', (event) => {
            var notification = event.notification;
            var action = event.action;
            
            console.log(notification);
            if(action == 'confirm'){
                console.log('使用者點選確認');
                localStorage.setItem('target', 1);
                window.location.replace('./pages/func.html');
            } else {
                console.log(action);
            }
        })
        self.addEventListener('notificationonclose', (event) => {
            alert('使用者沒興趣');
        })
    </script>
    
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.js"></script>
</html>