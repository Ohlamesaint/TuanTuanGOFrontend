<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./app.js"></script>
</head>
<body>
    <button class="enable-notification">允許推播</button>
    <script>
        let enableNotifications = document.querySelectorAll('.enable-notification');
        
        if('Notification' in window) {
            for(let i=0; i<enableNotifications.length; i++){
                enableNotifications[i].style.display = 'inline-block';
                enableNotifications[i].addEventListener('click', askForNotificationPermission);
            }
        }
        
        function askForNotificationPermission() {
            Notification.requestPermission((status) => {
                console.log('User choice', status);
                if(status!=='granted'){
                    console.log('user denied');
                } else {
                    setPushSubcribe();
                }
            })
        }
        
        function displayNotification() {
            if('serviceWorker' in navigator){
                var options = {
                    body: '團購中的訊息',
                    icon: './public/img/tuantuango196.png',
                    image: './public/img/tuantuango196.png',
                    dir: 'ltr',
                    lang: 'zh-Hant',
                    vibrate: [100],
                    badge: './public/img/tuantuango196.png',
                    tag: 'confirm-notification',
                    renotify: true,
                    actions: [{
                        action: 'confirm', title: '確認', icon: './public/img/tuantuango196.png'
                    },{
                        action: 'cancel', title: '取消', icon: './public/img/tuantuango196.png'
                    }]
                };
                navigator.serviceWorker.ready
                .then((sw) => {
                    sw.showNotification('訂閱成功', options);
                })
            }
        }

        function setPushSubcribe() {
            navigator.serviceWorker.ready
                .then((sw) => {
                    return sw.pushManager.getSubscription();
                }).then((sub) => {
                    console.log(sub);
                    if(sub === null){
                        reg.pushManager.subscribe({
                            userVisibleOnly: true
                        });
                    } else {
                        
                    }
                })
        }

        self.addEventListener('notificationonclick', (event) => {
            var notification = event.notification;
            var action = event.action;

            console.log(notification);
            if(action == 'confirm'){
                console.log('使用者點選確認');
                localStorage.setItem('target', 1);
                window.location.replace('./pages/func.html');
            } else {
                console.log(action);
            }
        })
        self.addEventListener('notificationonclose', (event) => {
            alert('使用者沒興趣');
        })
    </script>
    
</body>
</html>